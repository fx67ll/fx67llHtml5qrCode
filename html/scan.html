<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>扫一扫</title>
		<script src="https://unpkg.com/html5-qrcode"></script>
		<style>
			body {
				padding: 40px 0 0 0;
			}

			#upload-input {
				opacity: 0;
				filter: alpha(opacity=0);
				display: inline-block;
				width: 100%;
				height: 100%;
				line-height: 40px;
			}

			#upload-text {
				position: relative;
				bottom: 40px;
				user-select: none;
				line-height: 40px;
			}
		</style>
	</head>

	<body>
		<!-- 相机、文件方式同时只能使用一个，可根据自己需求修改，如: 1.改成下拉框; 2.改成tab; 3.改成radio等等控制显示隐藏和相应逻辑。 -->
		<!-- <button onclick="useLocal()">
			<input type="file" id="upload-input" accept="image/*" value="使用文件方式">
			<span id="upload-text">使用文件上传的方式</span>
		</button> -->
		
		<div id="reader"></div>
		<h3 id="qr-reader-results"></h3>
		
		<script>
			let html5QrCode = new Html5Qrcode("reader");
			let readerDom = document.getElementById("reader");
			let res = document.getElementById('qr-reader-results');
			// let uploadInput = document.getElementById('upload-input');
			let config = {
				fps: 10,
				qrbox: {
					width: 300,
					height: 280
				}
			};

			useCamera();

			// 相机授权
			function useCamera() {
				readerDom.style.display = "block";
				res.innerText = "";
				Html5Qrcode.getCameras()
					.then((devices) => {
						if (devices && devices.length) {
							let cameraId = "";
							if (devices.length == 1) {
								cameraId = devices[0].id; //前置摄像头
							} else {
								cameraId = devices[1].id; //后置摄像头
							}
							if (cameraId) {
								startWithCameraId(cameraId);
							}
						} else {
							startWithoutCameraId();
						}
					})
					.catch((err) => {
						alert(JSON.stringify(err));
						console.log("没有获取摄像头设备...");
					});
			}

			// 带相机ID扫描
			function startWithCameraId(cameraId) {
				html5QrCode
					.start({
							deviceId: {
								exact: cameraId
							}
						},
						config,
						onScanSuccess,
						onScanFailure
					)
					.catch((err) => {
						alert(JSON.stringify(err));
						console.log("通过摄像头扫码异常....", err);
					});
			}

			// 不带相机ID扫描，允许传递约束来代替相机设备 ID
			function startWithoutCameraId() {
				//environment 表示后置摄像头  换成user则表示前置摄像头
				html5QrCode.start({
						facingMode: "environment"
					} || {
						facingMode: {
							exact: "environment"
						},
					},
					config,
					onScanSuccess,
					onScanFailure
				);
			}

			// 扫码解析成功后按照自己的需求做后续的操作
			function onScanSuccess(decodedText, decodedResult) {
				res.innerText = "扫码成功结果:\n" + decodedText;
			}

			// 扫码解析失败后按照自己的需求做后续的操作
			function onScanFailure(error) {
				res.innerText = "扫码解析失败:\n" + error;
			}

			// 使用本地文件
			// function useLocal() {
			// 	readerDom.style.display = "none";
			// 	res.innerText = "";
			// 	uploadInput.addEventListener("change", (e) => {
			// 		if (e.target.files.length == 0) {
			// 			return;
			// 		}
			// 		const imageFile = e.target.files[0];
			// 		html5QrCode
			// 			.scanFile(imageFile, true)
			// 			.then((decodedText, decodedResult) => {
			// 				res.innerText = "扫码成功结果:\n" + decodedText;
			// 			})
			// 			.catch((err) => {
			// 				alert(JSON.stringify(err));
			// 				res.innerText = "扫码失败:\n" + error;
			// 			});
			// 	});
			// }
		</script>
	</body>
</html>
